<script>
  (function () {
    const state = {
      materials: [],
      purchases: [],
      formulas: [],
      logs: [],
      logFilters: {},
      liveTail: false,
      selectedLogIndex: null,
      sessionId: document.body.dataset.sessionId,
      requestCounter: 0
    };

    const logBuffer = new PerfumeLib.logBuffer.LogBuffer({ capacity: 5000, batchSize: 200 });
    const logSchema = PerfumeLib.logSchema;

    function nextRequestId(prefix) {
      state.requestCounter += 1;
      return `${prefix || 'req'}-${Date.now()}-${state.requestCounter}`;
    }

    function serializeForm(form) {
      const data = new FormData(form);
      const result = {};
      data.forEach((value, key) => {
        if (result[key]) {
          if (!Array.isArray(result[key])) {
            result[key] = [result[key]];
          }
          result[key].push(value);
        } else {
          result[key] = value;
        }
      });
      return result;
    }

    function renderMaterials() {
      const body = document.getElementById('materials-body');
      body.innerHTML = '';
      const fragment = document.createDocumentFragment();
      state.materials.forEach((material) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${material.materialId}</td>
          <td>${material.name || ''}</td>
          <td>${material.vendor || ''}</td>
          <td>${Number(material.pricePerMg || 0).toFixed(4)}</td>
          <td>${Number(material.stockMg || 0).toFixed(2)}</td>
          <td>${material.lastPurchaseIso || ''}</td>`;
        fragment.appendChild(tr);
      });
      body.appendChild(fragment);
    }

    function renderPurchases() {
      const body = document.getElementById('purchases-body');
      body.innerHTML = '';
      const fragment = document.createDocumentFragment();
      state.purchases.forEach((purchase) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${purchase.timestampIso}</td>
          <td>${purchase.materialId}</td>
          <td>${purchase.vendor || ''}</td>
          <td>${Number(purchase.quantityMg || 0).toFixed(2)}</td>
          <td>${Number(purchase.totalCost || 0).toFixed(2)}</td>
          <td>${Number(purchase.unitPrice || 0).toFixed(5)}</td>
          <td>${purchase.notes || ''}</td>`;
        fragment.appendChild(tr);
      });
      body.appendChild(fragment);
    }

    function renderFormulas() {
      const body = document.getElementById('formulas-body');
      body.innerHTML = '';
      const fragment = document.createDocumentFragment();
      state.formulas.forEach((formula) => {
        const tr = document.createElement('tr');
        tr.dataset.formulaId = formula.formulaId;
        tr.innerHTML = `
          <td>${formula.formulaId}</td>
          <td>${formula.name || ''}</td>
          <td>${Number(formula.margin || 0).toFixed(2)}</td>
          <td>${Number(formula.lastCost || 0).toFixed(2)}</td>
          <td>${Number(formula.sellingPrice || 0).toFixed(2)}</td>`;
        tr.addEventListener('click', () => populateFormulaForm(formula));
        fragment.appendChild(tr);
      });
      body.appendChild(fragment);
    }

    function renderLogs(entries = state.logs) {
      const body = document.getElementById('logs-body');
      body.innerHTML = '';
      const fragment = document.createDocumentFragment();
      entries.forEach((entry, index) => {
        const tr = document.createElement('tr');
        tr.dataset.index = index;
        tr.innerHTML = `
          <td>${entry.timestamp}</td>
          <td>${entry.level}</td>
          <td>${entry.origin}</td>
          <td>${entry.category}</td>
          <td>${entry.message}</td>
          <td>${entry.requestId}</td>`;
        tr.addEventListener('click', () => selectLog(index));
        fragment.appendChild(tr);
      });
      body.appendChild(fragment);
      document.querySelector('.logs-container').setAttribute('aria-rowcount', entries.length);
      updateLogStats(entries);
    }

    function selectLog(index) {
      state.selectedLogIndex = index;
      const rows = document.querySelectorAll('#logs-body tr');
      rows.forEach((row) => row.classList.remove('selected'));
      const selected = document.querySelector(`#logs-body tr[data-index="${index}"]`);
      if (selected) {
        selected.classList.add('selected');
      }
      const details = document.getElementById('log-details');
      const entry = state.logs[index];
      details.textContent = entry ? JSON.stringify(entry, null, 2) : 'Select a row to see details';
    }

    function updateLogStats(entries) {
      const invalidCount = entries.reduce((acc, entry) => (logSchema.validateLogEntry(entry).valid ? acc : acc + 1), 0);
      const errors = entries.filter((entry) => entry.level === 'error').length;
      const durationAvg = entries
        .map((entry) => Number(entry.details && entry.details.durationMs))
        .filter((value) => Number.isFinite(value));
      const avg = durationAvg.length
        ? (durationAvg.reduce((acc, value) => acc + value, 0) / durationAvg.length).toFixed(2)
        : '0.00';
      document.getElementById('log-stats').textContent = `Entries: ${entries.length} (errors: ${errors}, invalid: ${invalidCount}, avg duration: ${avg}ms)`;
    }

    function addComponentRow(container, data) {
      const row = document.createElement('div');
      row.className = 'component-row';
      row.innerHTML = `
        <input name="materialId" placeholder="Material ID" value="${data?.materialId || ''}" required />
        <input name="quantityMg" type="number" min="0" step="0.01" placeholder="Quantity (mg)" value="${
          data?.quantityMg || ''
        }" required />
        <button type="button" aria-label="Remove component">âœ•</button>`;
      row.querySelector('button').addEventListener('click', () => {
        container.removeChild(row);
        logUI('ui', 'Component removed', { container: container.id });
      });
      container.appendChild(row);
    }

    function collectComponents(container) {
      return Array.from(container.querySelectorAll('.component-row'))
        .map((row) => {
          return {
            materialId: row.querySelector('input[name="materialId"]').value,
            quantityMg: Number(row.querySelector('input[name="quantityMg"]').value)
          };
        })
        .filter((component) => component.materialId && Number.isFinite(component.quantityMg) && component.quantityMg > 0);
    }

    const DEFAULT_MARGIN_PERCENT = 25;

    function populateFormulaForm(formula) {
      const form = document.getElementById('formula-form');
      form.formulaId.value = formula.formulaId;
      form.name.value = formula.name || '';
      form.description.value = formula.description || '';
      form.margin.value =
        formula.margin != null && !Number.isNaN(Number(formula.margin))
          ? (Number(formula.margin) * 100).toFixed(2)
          : DEFAULT_MARGIN_PERCENT;
      const list = document.getElementById('components-list');
      list.innerHTML = '';
      (formula.components || []).forEach((component) => addComponentRow(list, component));
      logUI('ui', 'Formula populated', { formulaId: formula.formulaId });
    }

    function logUI(category, message, details) {
      enqueueLog({
        level: 'info',
        origin: 'client',
        category: category || 'ui',
        message,
        details: Object.assign({ timing: performance.now() }, details || {})
      });
    }

    function enqueueLog(entry) {
      const enriched = Object.assign(
        {
          timestamp: new Date().toISOString(),
          sessionId: state.sessionId,
          requestId: nextRequestId('client'),
          context: {
            userAgent: navigator.userAgent,
            locale: navigator.language
          }
        },
        entry
      );
      try {
        logBuffer.add(enriched);
      } catch (error) {
        console.warn('Skipping invalid log entry', error);
        return;
      }
      pendingLogs.push(enriched);
      scheduleLogFlush();
    }

    const pendingLogs = [];
    let flushTimeout = null;
    function scheduleLogFlush() {
      if (flushTimeout) {
        return;
      }
      flushTimeout = setTimeout(flushLogs, 1500);
    }

    function flushLogs() {
      if (!pendingLogs.length) {
        flushTimeout = null;
        return;
      }
      const batch = pendingLogs.splice(0, pendingLogs.length);
      const requestId = nextRequestId('batch');
      google.script.run
        .withSuccessHandler(() => {
          flushTimeout = null;
          if (pendingLogs.length) {
            scheduleLogFlush();
          }
        })
        .withFailureHandler((err) => {
          console.error('Failed to persist client logs', err);
          pendingLogs.unshift.apply(pendingLogs, batch);
          flushTimeout = null;
          scheduleLogFlush();
        })
        .recordClientLogs(batch, { sessionId: state.sessionId, requestId });
    }

    function captureConsole() {
      ['log', 'info', 'warn', 'error', 'debug'].forEach((level) => {
        const original = console[level] ? console[level].bind(console) : console.log.bind(console);
        console[level] = function (...args) {
          original(...args);
          enqueueLog({
            level: level === 'log' ? 'info' : level,
            origin: 'client',
            category: 'ui',
            message: args.map((value) => (typeof value === 'string' ? value : JSON.stringify(value))).join(' '),
            details: {
              payloadSize: JSON.stringify(args).length
            }
          });
        };
      });
    }

    function captureErrors() {
      window.addEventListener('error', (event) => {
        enqueueLog({
          level: 'error',
          category: 'ui',
          message: event.message,
          details: {
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            stack: event.error && event.error.stack
          }
        });
      });
      window.addEventListener('unhandledrejection', (event) => {
        enqueueLog({
          level: 'error',
          category: 'ui',
          message: 'Unhandled rejection',
          details: {
            reason: event.reason && event.reason.message,
            stack: event.reason && event.reason.stack
          }
        });
      });
    }

    function captureFetch() {
      const originalFetch = window.fetch;
      window.fetch = function (...args) {
        const start = performance.now();
        return originalFetch.apply(this, args).then(
          (response) => {
            const duration = performance.now() - start;
            enqueueLog({
              level: 'info',
              category: 'http',
              message: 'Fetch completed',
              details: {
                url: String(args[0]),
                status: response.status,
                durationMs: duration
              }
            });
            return response;
          },
          (error) => {
            const duration = performance.now() - start;
            enqueueLog({
              level: 'error',
              category: 'http',
              message: 'Fetch failed',
              details: {
                url: String(args[0]),
                durationMs: duration,
                stack: error && error.stack
              }
            });
            throw error;
          }
        );
      };
    }

    function switchTab(tabId) {
      document.querySelectorAll('.tab-panel').forEach((panel) => {
        const hidden = panel.id !== tabId;
        panel.classList.toggle('hidden', hidden);
        panel.setAttribute('aria-hidden', hidden);
      });
      document.querySelectorAll('.tab-button').forEach((button) => {
        const selected = button.dataset.tab === tabId;
        button.setAttribute('aria-selected', selected);
      });
      logUI('ui', 'Tab switched', { tabId });
    }

    function setupTabs() {
      document.querySelectorAll('.tab-button').forEach((button) => {
        button.addEventListener('click', () => switchTab(button.dataset.tab));
      });
    }

    function setupForms() {
      document.getElementById('purchase-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const payload = serializeForm(event.target);
        payload.quantityMg = Number(payload.quantityMg);
        payload.totalCost = Number(payload.totalCost);
        if (!payload.materialId) {
          alert('Material ID is required');
          return;
        }
        logUI('ui', 'Submit purchase', payload);
        google.script.run
          .withSuccessHandler((data) => {
            state.materials = data.materials;
            state.purchases = data.purchases;
            renderMaterials();
            renderPurchases();
            event.target.reset();
            logUI('ui', 'Purchase recorded', data.purchase);
          })
          .withFailureHandler((err) => {
            console.error('Failed to record purchase', err);
            alert('Failed to record purchase: ' + err.message);
          })
          .recordPurchaseApi(payload);
      });

      document.getElementById('add-component').addEventListener('click', () => {
        addComponentRow(document.getElementById('components-list'));
      });

      document.getElementById('formula-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const payload = serializeForm(event.target);
        payload.components = collectComponents(document.getElementById('components-list'));
        if (payload.margin !== '' && payload.margin != null) {
          const marginValue = Number(payload.margin);
          if (Number.isNaN(marginValue) || marginValue < 0) {
            alert('Margin must be a non-negative number');
            return;
          }
          payload.margin = marginValue / 100;
        } else {
          delete payload.margin;
        }
        if (!payload.components.length) {
          alert('Add at least one component');
          return;
        }
        google.script.run
          .withSuccessHandler((data) => {
            state.formulas = data.formulas;
            renderFormulas();
            logUI('ui', 'Formula saved', data);
          })
          .withFailureHandler((err) => {
            console.error('Failed to save formula', err);
            alert('Failed to save formula: ' + err.message);
          })
          .saveFormulaApi(payload);
      });

      document.getElementById('add-production-component').addEventListener('click', () => {
        addComponentRow(document.getElementById('production-components'));
      });

      document.getElementById('production-form').addEventListener('submit', (event) => {
        event.preventDefault();
        const payload = serializeForm(event.target);
        payload.components = collectComponents(document.getElementById('production-components'));
        if (payload.margin !== '' && payload.margin != null) {
          const marginValue = Number(payload.margin);
          if (Number.isNaN(marginValue) || marginValue < 0) {
            alert('Margin must be a non-negative number');
            return;
          }
          payload.margin = marginValue / 100;
        } else {
          delete payload.margin;
        }
        if (!payload.components.length) {
          alert('Add at least one component');
          return;
        }
        google.script.run
          .withSuccessHandler((data) => {
            state.materials = data.materials;
            renderMaterials();
            alert('Bottle recorded. Cost: ' + data.production.calculation.cost.toFixed(2));
            logUI('ui', 'Production recorded', data.production);
          })
          .withFailureHandler((err) => {
            console.error('Failed to record production', err);
            alert('Failed to record production: ' + err.message);
          })
          .recordProductionApi(payload);
      });
    }

    function applyFilters(filters) {
      state.logFilters = Object.assign({}, filters);
      const filtered = state.logs.filter((entry) => {
        if (filters.level && entry.level !== filters.level) return false;
        if (filters.origin && entry.origin !== filters.origin) return false;
        if (filters.category && entry.category !== filters.category) return false;
        if (filters.search) {
          const haystack = JSON.stringify(entry).toLowerCase();
          if (!haystack.includes(String(filters.search).toLowerCase())) return false;
        }
        if (filters.since) {
          const sinceIso = new Date(filters.since).toISOString();
          if (entry.timestamp < sinceIso) return false;
        }
        return true;
      });
      renderLogs(filtered);
    }

    function setupLogFilters() {
      const form = document.getElementById('log-filters');
      form.addEventListener('submit', (event) => {
        event.preventDefault();
        const payload = serializeForm(form);
        applyFilters(payload);
        fetchLogs(true);
      });
      document.getElementById('reset-filters').addEventListener('click', () => {
        form.reset();
        state.logFilters = {};
        renderLogs(state.logs);
      });
    }

    function setupLogControls() {
      const toggleButton = document.getElementById('toggle-live');
      toggleButton.addEventListener('click', () => {
        state.liveTail = !state.liveTail;
        toggleButton.textContent = state.liveTail ? 'Stop Live Tail' : 'Start Live Tail';
        if (state.liveTail) {
          fetchLogs(true);
        }
      });

      document.getElementById('export-jsonl').addEventListener('click', () => exportLogs('jsonl'));
      document.getElementById('export-csv').addEventListener('click', () => exportLogs('csv'));
      document.getElementById('copy-selection').addEventListener('click', copySelectedLog);
    }

    function exportLogs(format) {
      const filters = state.logFilters;
      google.script.run
        .withSuccessHandler((content) => {
          const blob = new Blob([content], { type: format === 'csv' ? 'text/csv' : 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `perfume-logs.${format}`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          logUI('ui', 'Logs exported', { format });
        })
        .withFailureHandler((err) => {
          console.error('Failed to export logs', err);
          alert('Failed to export logs: ' + err.message);
        })
        .exportLogsApi(filters, format);
    }

    function copySelectedLog() {
      if (state.selectedLogIndex == null) {
        alert('Select a log row to copy');
        return;
      }
      const entry = state.logs[state.selectedLogIndex];
      const text = JSON.stringify(entry, null, 2);
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => logUI('ui', 'Log copied', { requestId: entry.requestId }))
          .catch((error) => console.error('Failed to copy log', error));
      } else {
        const textarea = document.createElement('textarea');
        textarea.className = 'sr-only';
        textarea.value = text;
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          logUI('ui', 'Log copied', { requestId: entry.requestId, fallback: true });
        } catch (error) {
          console.error('Failed to copy log', error);
        }
        document.body.removeChild(textarea);
      }
    }

    function fetchLogs(force) {
      if (!force && !state.liveTail) {
        return;
      }
      google.script.run
        .withSuccessHandler((data) => {
          const validEntries = data.entries.filter((entry) => logSchema.validateLogEntry(entry).valid);
          state.logs = validEntries.slice(-5000);
          renderLogs(state.logFilters ? state.logs.filter((entry) => {
            if (state.logFilters.level && entry.level !== state.logFilters.level) return false;
            if (state.logFilters.origin && entry.origin !== state.logFilters.origin) return false;
            if (state.logFilters.category && entry.category !== state.logFilters.category) return false;
            if (state.logFilters.search) {
              const haystack = JSON.stringify(entry).toLowerCase();
              if (!haystack.includes(String(state.logFilters.search).toLowerCase())) return false;
            }
            if (state.logFilters.since) {
              const sinceIso = new Date(state.logFilters.since).toISOString();
              if (entry.timestamp < sinceIso) return false;
            }
            return true;
          }) : state.logs);
          if (state.liveTail) {
            setTimeout(() => fetchLogs(true), 5000);
          }
        })
        .withFailureHandler((err) => {
          console.error('Failed to fetch logs', err);
        })
        .fetchLogsApi(state.logFilters);
    }

    function populateInitialData(data) {
      state.materials = data.materials || [];
      state.purchases = data.purchases || [];
      state.formulas = data.formulas || [];
      state.logs = data.logs || [];
      renderMaterials();
      renderPurchases();
      renderFormulas();
      renderLogs();
    }

    function init() {
      captureConsole();
      captureErrors();
      captureFetch();
      setupTabs();
      setupForms();
      setupLogFilters();
      setupLogControls();
      if (!document.getElementById('components-list').children.length) {
        addComponentRow(document.getElementById('components-list'));
      }
      if (!document.getElementById('production-components').children.length) {
        addComponentRow(document.getElementById('production-components'));
      }
      logUI('ui', 'App initialized', {});
      google.script.run
        .withSuccessHandler((data) => {
          populateInitialData(data);
          logUI('ui', 'Initial data loaded', {
            materials: data.materials && data.materials.length,
            formulas: data.formulas && data.formulas.length
          });
        })
        .withFailureHandler((err) => {
          console.error('Failed to load initial data', err);
          alert('Failed to load initial data: ' + err.message);
        })
        .getInitialData();
    }

    document.addEventListener('DOMContentLoaded', init);
  })();
</script>
